<!DOCTYPE html>
<html lang="en">
  <head>
    <!-- Meta tags and title -->
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Data Analysis Extension</title>

    <!-- Link to the stylesheet -->
    <link href="style.css" rel="stylesheet" />

    <!-- Include local Font Awesome CSS -->
    <link rel="stylesheet" href="css/all.min.css" />
  </head>
  <body>
    <!-- Main Menu -->
    <div id="mainMenu">
      <!-- Main Buttons with Icons -->
      <button id="categoryButton" class="main-button">
        <i class="fas fa-list"></i>
        <span>Select Category</span>
      </button>
      <button id="operationButton" class="main-button">
        <i class="fas fa-cogs"></i>
        <span>Select Operation</span>
      </button>
      <button id="columnButton" class="main-button">
        <i class="fas fa-columns"></i>
        <span>Select Columns</span>
      </button>

      <!-- Create Custom Operation Button -->
      <button id="createCustomOperationButton" class="main-button">
        <i class="fas fa-plus-circle"></i>
        <span>Create Custom Operation</span>
      </button>

      <!-- New Button for Managing Custom Operations -->
      <button id="manageCustomOperationsButton" class="main-button">
        <i class="fas fa-edit"></i>
        <span>Manage Custom Operations</span>
      </button>

      <!-- Secondary Buttons Container -->
      <div class="secondary-buttons-container">
        <!-- Secondary Buttons -->
        <button
          id="changeFileButton"
          class="secondary-button"
          title="Change File"
        >
          <i class="fas fa-folder-open"></i>
        </button>
        <button
          id="previewButton"
          class="secondary-button"
          title="Preview Data"
        >
          <i class="fas fa-eye"></i>
        </button>
        <button
          id="queueOperation"
          class="secondary-button"
          title="Queue Operation"
        >
          <i class="fas fa-plus"></i>
        </button>
        <button
          id="performOperations"
          class="secondary-button"
          title="Perform Operations"
        >
          <i class="fas fa-play"></i>
        </button>
      </div>
    </div>

    <!-- Secondary Pages -->
    <!-- Category Selection Page -->
    <div id="categoryPage" style="display: none">
      <h2>Select Category</h2>
      <ul id="categoryList">
        <!-- Categories will be dynamically added here -->
      </ul>
      <button id="confirmCategory" class="main-button">
        <i class="fas fa-check"></i>
        <span>Confirm</span>
      </button>
      <button class="backToMain main-button">
        <i class="fas fa-arrow-left"></i>
        <span>Go Back to Main Menu</span>
      </button>
    </div>

    <!-- Operation Selection Page -->
    <div id="operationPage" style="display: none">
      <h2>Select Operation</h2>
      <ul id="operationList">
        <!-- Operations will be dynamically added here -->
      </ul>
      <!-- User Input Field -->
      <div id="userInputContainer" style="display: none">
        <h3>User Inputs:</h3>
        <div id="userInputFieldsContainer">
          <!-- User input fields will be added here dynamically -->
        </div>
      </div>
      <button id="confirmOperation" class="main-button">
        <i class="fas fa-check"></i>
        <span>Confirm</span>
      </button>
      <button class="backToMain main-button">
        <i class="fas fa-arrow-left"></i>
        <span>Go Back to Main Menu</span>
      </button>
    </div>

    <!-- Columns Selection Page -->
    <div id="columnPage" style="display: none">
      <h2>Select Columns</h2>
      <ul id="columnList">
        <!-- Columns will be dynamically added here -->
      </ul>
      <button id="confirmColumns" class="main-button">
        <i class="fas fa-check"></i>
        <span>Confirm</span>
      </button>
      <button class="backToMain main-button">
        <i class="fas fa-arrow-left"></i>
        <span>Go Back to Main Menu</span>
      </button>
    </div>

    <!-- Data Preview Container -->
    <div id="dataPreviewContainer" style="display: none">
      <h3>Data Preview:</h3>
      <button class="backToMain main-button">
        <i class="fas fa-arrow-left"></i>
        <span>Go Back to Main Menu</span>
      </button>
      <div class="data-table-container">
        <table id="dataPreviewTable"></table>
      </div>
    </div>

    <!-- Create Custom Operation Page -->
    <div id="createCustomOperationPage" style="display: none">
      <h2>Create Custom Operation</h2>
      <p style="color: red; text-align: center">
        Warning: Custom operations can execute code on your system. Only add
        code you trust.
      </p>
      <form id="customOperationForm">
        <label for="operationName">Operation Name:</label>
        <input type="text" id="operationName" required />

        <label for="operationCategory">Category:</label>
        <input type="text" id="operationCategory" required autocomplete="off" />
        <div id="categorySuggestions" class="suggestions-list">
          <!-- Suggestions will be dynamically added here -->
        </div>

        <label for="needsUserInput">Needs User Input:</label>
        <input type="checkbox" id="needsUserInput" />

        <!-- User Inputs Container -->
        <div id="userInputsContainer" style="display: none">
          <h3>User Inputs:</h3>
          <div id="userInputsList">
            <!-- User input fields will be added here dynamically -->
          </div>
          <button
            type="button"
            id="addUserInputButton"
            class="secondary-button"
          >
            <i class="fas fa-plus"></i> Add User Input
          </button>
        </div>

        <label for="operationCode">Operation Code:</label>
        <textarea id="operationCode" rows="10" required></textarea>

        <button type="submit" class="main-button">
          <i class="fas fa-save"></i>
          <span>Save Operation</span>
        </button>
      </form>
      <button class="backToMain main-button">
        <i class="fas fa-arrow-left"></i>
        <span>Go Back to Main Menu</span>
      </button>
    </div>

    <!-- Manage Custom Operations Page -->
    <div id="manageCustomOperationsPage" style="display: none">
      <h2>Manage Custom Operations</h2>
      <ul id="customOperationsList">
        <!-- Custom operations will be dynamically added here -->
      </ul>
      <button class="backToMain main-button">
        <i class="fas fa-arrow-left"></i>
        <span>Go Back to Main Menu</span>
      </button>
    </div>

    <!-- Queued Operations Display -->
    <div id="queueContainer">
      <h3>Queued Operations:</h3>
      <ul id="operationQueue">
        <!-- Queued operations will be displayed here -->
      </ul>
    </div>

    <!-- JavaScript Code -->
    <script>
      const vscode = acquireVsCodeApi();

      // Variables to store user selections
      let selectedCategory = null;
      let selectedOperation = null;
      let selectedColumns = [];
      let selectedOperationRequiresInput = false;
      let selectedOperationPlaceholders = [];
      let existingCategories = []; // Store existing categories

      // References to elements
      const operationCategoryInput =
        document.getElementById("operationCategory");
      const categorySuggestionsContainer = document.getElementById(
        "categorySuggestions"
      );

      // Array to store queued operations
      let operationQueue = [];

      // Get references to user input elements
      const userInputContainer = document.getElementById("userInputContainer");
      const userInputFieldsContainer = document.getElementById(
        "userInputFieldsContainer"
      );

      // Navigation functions
      function navigateToPage(pageId) {
        // Hide all pages
        const pages = [
          "mainMenu",
          "categoryPage",
          "operationPage",
          "columnPage",
          "dataPreviewContainer",
          "createCustomOperationPage",
          "manageCustomOperationsPage", // Added page
        ];
        pages.forEach((id) => {
          document.getElementById(id).style.display = "none";
        });
        // Show the selected page
        document.getElementById(pageId).style.display = "block";
      }

      // Reset selections function
      function resetSelections() {
        // Reset selection variables
        selectedCategory = null;
        selectedOperation = null;
        selectedColumns = [];
        selectedOperationRequiresInput = false;
        selectedOperationPlaceholders = [];

        // Reset UI selections
        // Deselect category
        const categoryList = document.getElementById("categoryList");
        if (categoryList) {
          Array.from(categoryList.children).forEach((el) =>
            el.classList.remove("selected")
          );
        }

        // Clear operations list
        const operationList = document.getElementById("operationList");
        if (operationList) {
          operationList.innerHTML = "";
        }

        // Deselect columns
        const columnList = document.getElementById("columnList");
        if (columnList) {
          Array.from(columnList.children).forEach((el) =>
            el.classList.remove("selected")
          );
        }

        // Hide user input container
        userInputContainer.style.display = "none";
        userInputFieldsContainer.innerHTML = "";
      }

      // Event listeners for main menu buttons
      document
        .getElementById("categoryButton")
        .addEventListener("click", () => {
          navigateToPage("categoryPage");
          // Request categories from the extension
          vscode.postMessage({ command: "requestCategories" });
        });

      document
        .getElementById("operationButton")
        .addEventListener("click", () => {
          if (!selectedCategory) {
            alert("Please select a category first.");
            return;
          }
          navigateToPage("operationPage");
          // Request operations for the selected category
          vscode.postMessage({
            command: "categorySelected",
            category: selectedCategory,
          });
        });

      document.getElementById("columnButton").addEventListener("click", () => {
        navigateToPage("columnPage");
        // Columns should have been received on startup
      });

      document
        .getElementById("changeFileButton")
        .addEventListener("click", () => {
          vscode.postMessage({ command: "changeFile" });
        });

      document.getElementById("previewButton").addEventListener("click", () => {
        vscode.postMessage({ command: "previewData" });
      });

      // Event listener for "Queue Operation" button
      document
        .getElementById("queueOperation")
        .addEventListener("click", queueOperation);

      // Event listener for "Perform Operation(s)" button
      document
        .getElementById("performOperations")
        .addEventListener("click", () => {
          if (operationQueue.length === 0) {
            alert("No operations queued.");
            return;
          }

          vscode.postMessage({
            command: "performOperations",
            operations: operationQueue,
          });

          // Clear the operation queue after performing
          operationQueue = [];
          updateOperationQueueDisplay();
        });

      // Function to queue an operation
      function queueOperation() {
        if (
          !selectedCategory ||
          !selectedOperation ||
          selectedColumns.length === 0
        ) {
          alert(
            "Please ensure you have selected a category, operation, and at least one column."
          );
          return;
        }

        let userInputs = [];
        if (selectedOperationRequiresInput) {
          const userInputFields = document.querySelectorAll(".userInputField");
          userInputFields.forEach((input) => {
            userInputs.push(input.value.trim());
          });
        }

        // Add the operation to the queue
        operationQueue.push({
          category: selectedCategory,
          operationName: selectedOperation,
          columns: selectedColumns.slice(),
          userInputs: userInputs,
        });

        // Update the operation queue display
        updateOperationQueueDisplay();

        // Reset selections for the next operation
        resetSelections();
        navigateToPage("mainMenu");
      }

      // Function to update the displayed operation queue
      function updateOperationQueueDisplay() {
        const operationQueueList = document.getElementById("operationQueue");
        operationQueueList.innerHTML = ""; // Clear the list

        operationQueue.forEach((op, index) => {
          let listItem = document.createElement("li");
          listItem.textContent = `${index + 1}. ${
            op.operationName
          } on [${op.columns.join(", ")}]`;
          if (op.userInputs && op.userInputs.length > 0) {
            listItem.textContent += ` with inputs: "${op.userInputs.join(
              '", "'
            )}"`;
          }
          operationQueueList.appendChild(listItem);
        });
      }

      // Event listeners for "Go Back to Main Menu" buttons
      document.querySelectorAll(".backToMain").forEach((button) => {
        button.addEventListener("click", () => {
          navigateToPage("mainMenu");
        });
      });

      // Category selection handling
      function setCategoryOptions(categories) {
        existingCategories = categories; // Store for later use
        const categoryList = document.getElementById("categoryList");
        categoryList.innerHTML = ""; // Clear previous categories
        categories.forEach((category) => {
          const option = document.createElement("li");
          option.textContent = category;
          option.addEventListener("click", () => {
            Array.from(categoryList.children).forEach((el) =>
              el.classList.remove("selected")
            );
            option.classList.add("selected");
            selectedCategory = category;
          });
          categoryList.appendChild(option);
        });
      }

      // Operation selection handling
      function setOperationOptions(operations) {
        const operationList = document.getElementById("operationList");
        operationList.innerHTML = ""; // Clear previous operations
        operations.forEach((operation) => {
          const option = document.createElement("li");
          option.textContent = operation.name;
          option.addEventListener("click", () => {
            Array.from(operationList.children).forEach((el) =>
              el.classList.remove("selected")
            );
            option.classList.add("selected");
            selectedOperation = operation.name;
            selectedOperationRequiresInput = operation.needsUserInput || false;
            selectedOperationPlaceholders =
              operation.userInputPlaceholders || [];

            if (selectedOperationRequiresInput) {
              userInputContainer.style.display = "block";
              userInputFieldsContainer.innerHTML = ""; // Clear previous inputs

              selectedOperationPlaceholders.forEach((placeholder, index) => {
                const inputDiv = document.createElement("div");
                inputDiv.className = "user-input-item";

                const label = document.createElement("label");
                label.textContent = placeholder;

                const inputField = document.createElement("input");
                inputField.type = "text";
                inputField.className = "userInputField";
                inputField.dataset.index = index;
                inputField.required = true;

                inputDiv.appendChild(label);
                inputDiv.appendChild(inputField);
                userInputFieldsContainer.appendChild(inputDiv);
              });
            } else {
              userInputContainer.style.display = "none";
            }
          });
          operationList.appendChild(option);
        });
      }

      // Columns selection handling
      function setColumnOptions(columns) {
        const columnList = document.getElementById("columnList");
        columnList.innerHTML = ""; // Clear previous columns
        columns.forEach((column) => {
          const option = document.createElement("li");
          option.textContent = column;
          option.addEventListener("click", () => {
            if (option.classList.contains("selected")) {
              option.classList.remove("selected");
              selectedColumns = selectedColumns.filter((col) => col !== column);
            } else {
              option.classList.add("selected");
              selectedColumns.push(column);
            }
          });
          columnList.appendChild(option);
        });
      }

      // Confirm Category Selection
      document
        .getElementById("confirmCategory")
        .addEventListener("click", () => {
          if (!selectedCategory) {
            alert("Please select a category.");
            return;
          }
          navigateToPage("mainMenu");
        });

      // Confirm Operation Selection
      document
        .getElementById("confirmOperation")
        .addEventListener("click", () => {
          if (!selectedOperation) {
            alert("Please select an operation.");
            return;
          }
          navigateToPage("mainMenu");
        });

      // Confirm Columns Selection
      document
        .getElementById("confirmColumns")
        .addEventListener("click", () => {
          if (selectedColumns.length === 0) {
            alert("Please select at least one column.");
            return;
          }
          navigateToPage("mainMenu");
        });

      // Display data preview
      function displayDataPreview(data) {
        const dataPreviewTable = document.getElementById("dataPreviewTable");
        dataPreviewTable.innerHTML = ""; // Clear previous preview data
        data.forEach((row, index) => {
          const rowElement = document.createElement("tr");
          row.forEach((cell) => {
            const cellElement = document.createElement(
              index === 0 ? "th" : "td"
            );
            cellElement.textContent = cell;
            rowElement.appendChild(cellElement);
          });
          dataPreviewTable.appendChild(rowElement);
        });
        navigateToPage("dataPreviewContainer"); // Show the preview page
      }

      // Event listener for "Create Custom Operation" button
      document
        .getElementById("createCustomOperationButton")
        .addEventListener("click", () => {
          navigateToPage("createCustomOperationPage");
          // Request categories to populate suggestions
          vscode.postMessage({ command: "requestCategories" });
        });

      // Event listener for "Manage Custom Operations" button
      document
        .getElementById("manageCustomOperationsButton")
        .addEventListener("click", () => {
          navigateToPage("manageCustomOperationsPage");
          // Request custom operations from the extension
          vscode.postMessage({ command: "requestCustomOperations" });
        });

      // Function to display custom operations
      function displayCustomOperations(customOperations) {
        const customOperationsList = document.getElementById(
          "customOperationsList"
        );
        customOperationsList.innerHTML = ""; // Clear previous entries

        customOperations.forEach((operation) => {
          const listItem = document.createElement("li");
          listItem.className = "custom-operation-item";
          listItem.innerHTML = `
            <span><strong>${operation.name}</strong> (${operation.category})</span>
            <button class="delete-operation-button" data-operation="${operation.fileName}">
              <i class="fas fa-trash-alt"></i> Delete
            </button>
          `;

          customOperationsList.appendChild(listItem);
        });

        // Add event listeners for delete buttons
        const deleteButtons = customOperationsList.querySelectorAll(
          ".delete-operation-button"
        );
        deleteButtons.forEach((button) => {
          button.addEventListener("click", (event) => {
            const operationFileName = event.currentTarget.dataset.operation;
            // Instead of confirm(), send a message to the extension to confirm deletion
            vscode.postMessage({
              command: "confirmDeleteCustomOperation",
              fileName: operationFileName,
            });
          });
        });
      }

      // Handle deletion confirmation and process
      window.addEventListener("message", (event) => {
        const message = event.data;
        switch (message.command) {
          case "setColumns":
            setColumnOptions(message.columns);
            break;
          case "setCategories":
            setCategoryOptions(message.categories);
            break;
          case "setOperations":
            setOperationOptions(message.operations);
            break;
          case "showDataPreview":
            displayDataPreview(message.data);
            break;
          case "setCustomOperations":
            displayCustomOperations(message.customOperations);
            break;
          case "deleteOperationSuccess":
            vscode.window.showInformationMessage(message.message);
            // Refresh the custom operations list
            vscode.postMessage({ command: "requestCustomOperations" });
            break;
          case "deleteOperationFailure":
            vscode.window.showErrorMessage(message.message);
            break;
          default:
            console.error(`Unknown command received: ${message.command}`);
            break;
        }
      });

      // Show or hide the user inputs container based on the checkbox
      document
        .getElementById("needsUserInput")
        .addEventListener("change", function () {
          const userInputsContainer = document.getElementById(
            "userInputsContainer"
          );
          if (this.checked) {
            userInputsContainer.style.display = "block";
          } else {
            userInputsContainer.style.display = "none";
            document.getElementById("userInputsList").innerHTML = "";
          }
        });

      // Handle adding user input placeholders
      document
        .getElementById("addUserInputButton")
        .addEventListener("click", function () {
          const userInputsList = document.getElementById("userInputsList");
          const inputCount = userInputsList.children.length + 1;

          const inputDiv = document.createElement("div");
          inputDiv.className = "user-input-item";

          const label = document.createElement("label");
          label.textContent = `User Input ${inputCount} Placeholder:`;

          const inputField = document.createElement("input");
          inputField.type = "text";
          inputField.className = "userInputPlaceholder";
          inputField.required = true;

          inputDiv.appendChild(label);
          inputDiv.appendChild(inputField);
          userInputsList.appendChild(inputDiv);
        });

      // Handle the custom operation form submission
      document
        .getElementById("customOperationForm")
        .addEventListener("submit", function (event) {
          event.preventDefault(); // Prevent default form submission

          // Collect form data
          let operationName = document
            .getElementById("operationName")
            .value.trim();
          let operationCategory = operationCategoryInput.value.trim();
          const needsUserInput =
            document.getElementById("needsUserInput").checked;
          const operationCode = document.getElementById("operationCode").value;

          // Collect multiple user input placeholders
          let userInputPlaceholders = [];
          if (needsUserInput) {
            const userInputFields = document.querySelectorAll(
              ".userInputPlaceholder"
            );
            userInputFields.forEach((input) => {
              userInputPlaceholders.push(input.value.trim());
            });
          }

          // Perform case-insensitive category matching
          const matchedCategory = existingCategories.find(
            (cat) => cat.toLowerCase() === operationCategory.toLowerCase()
          );
          if (matchedCategory) {
            operationCategory = matchedCategory; // Use the existing category with original casing
          }

          // Send the data to the extension backend
          vscode.postMessage({
            command: "createCustomOperation",
            data: {
              name: operationName,
              category: operationCategory,
              needsUserInput: needsUserInput,
              userInputPlaceholders: userInputPlaceholders,
              operationCode: operationCode,
            },
          });

          // Reset the form
          this.reset();
          document.getElementById("userInputsContainer").style.display = "none";
          document.getElementById("userInputsList").innerHTML = "";

          // Navigate back to main menu
          navigateToPage("mainMenu");
        });

      // Event listeners for custom autocomplete
      operationCategoryInput.addEventListener("input", onCategoryInputChange);

      operationCategoryInput.addEventListener("focus", onCategoryInputFocus);

      operationCategoryInput.addEventListener("blur", () => {
        setTimeout(() => {
          categorySuggestionsContainer.style.display = "none";
        }, 200);
      });

      function onCategoryInputChange() {
        const inputValue = operationCategoryInput.value.toLowerCase();
        categorySuggestionsContainer.innerHTML = ""; // Clear previous suggestions

        if (inputValue === "") {
          categorySuggestionsContainer.style.display = "none";
          return;
        }

        const filteredCategories = existingCategories.filter((category) =>
          category.toLowerCase().includes(inputValue)
        );

        if (filteredCategories.length === 0) {
          categorySuggestionsContainer.style.display = "none";
          return;
        }

        filteredCategories.forEach((category) => {
          const suggestionItem = document.createElement("div");
          suggestionItem.classList.add("suggestion-item");
          suggestionItem.textContent = category;

          suggestionItem.addEventListener("click", () => {
            operationCategoryInput.value = category;
            categorySuggestionsContainer.innerHTML = "";
            categorySuggestionsContainer.style.display = "none";
          });

          categorySuggestionsContainer.appendChild(suggestionItem);
        });

        categorySuggestionsContainer.style.display = "block";
      }

      function onCategoryInputFocus() {
        if (operationCategoryInput.value !== "") {
          onCategoryInputChange();
        }
      }

      // Message handling from the extension
      window.addEventListener("message", (event) => {
        const message = event.data;
        switch (message.command) {
          case "setColumns":
            setColumnOptions(message.columns);
            break;
          case "setCategories":
            setCategoryOptions(message.categories);
            break;
          case "setOperations":
            setOperationOptions(message.operations);
            break;
          case "showDataPreview":
            displayDataPreview(message.data);
            break;
          case "setCustomOperations":
            displayCustomOperations(message.customOperations);
            break;
          case "deleteOperationSuccess":
            vscode.window.showInformationMessage(message.message);
            // Refresh the custom operations list
            vscode.postMessage({ command: "requestCustomOperations" });
            break;
          case "deleteOperationFailure":
            vscode.window.showErrorMessage(message.message);
            break;
          default:
            console.error(`Unknown command received: ${message.command}`);
            break;
        }
      });

      // Notify the extension that the webview is ready
      vscode.postMessage({ command: "ready" });
    </script>
  </body>
</html>
