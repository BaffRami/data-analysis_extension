<!DOCTYPE html>
<html lang="en">
  <head>
    <!-- Meta tags and title -->
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Data Analysis Extension</title>

    <!-- Link to the stylesheet -->
    <link href="style.css" rel="stylesheet" />

    <!-- Include local Font Awesome CSS -->
    <link rel="stylesheet" href="css/all.min.css" />
  </head>
  <body>
    <!-- Main Menu -->
    <div id="mainMenu">
      <!-- Main Buttons with Icons -->
      <button id="categoryButton" class="main-button">
        <i class="fas fa-list"></i>
        <span>Select Category</span>
      </button>
      <button id="operationButton" class="main-button">
        <i class="fas fa-cogs"></i>
        <span>Select Operation</span>
      </button>
      <button id="columnButton" class="main-button">
        <i class="fas fa-columns"></i>
        <span>Select Columns</span>
      </button>

      <!-- Secondary Buttons Container -->
      <div class="secondary-buttons-container">
        <!-- Secondary Buttons -->
        <button
          id="changeFileButton"
          class="secondary-button"
          title="Change File"
        >
          <i class="fas fa-folder-open"></i>
        </button>
        <button
          id="previewButton"
          class="secondary-button"
          title="Preview Data"
        >
          <i class="fas fa-eye"></i>
        </button>
        <button
          id="queueOperation"
          class="secondary-button"
          title="Queue Operation"
        >
          <i class="fas fa-plus"></i>
        </button>
        <button
          id="performOperations"
          class="secondary-button"
          title="Perform Operations"
        >
          <i class="fas fa-play"></i>
        </button>
      </div>
    </div>

    <!-- Secondary Pages -->
    <!-- Category Selection Page -->
    <div id="categoryPage" style="display: none">
      <h2>Select Category</h2>
      <ul id="categoryList">
        <!-- Categories will be dynamically added here -->
      </ul>
      <button id="confirmCategory" class="main-button">
        <i class="fas fa-check"></i>
        <span>Confirm</span>
      </button>
      <button class="backToMain main-button">
        <i class="fas fa-arrow-left"></i>
        <span>Go Back to Main Menu</span>
      </button>
    </div>

    <!-- Operation Selection Page -->
    <div id="operationPage" style="display: none">
      <h2>Select Operation</h2>
      <ul id="operationList">
        <!-- Operations will be dynamically added here -->
      </ul>
      <!-- User Input Field -->
      <div id="userInputContainer" style="display: none">
        <label for="userInputField" id="userInputLabel"></label>
        <input type="text" id="userInputField" />
      </div>
      <button id="confirmOperation" class="main-button">
        <i class="fas fa-check"></i>
        <span>Confirm</span>
      </button>
      <button class="backToMain main-button">
        <i class="fas fa-arrow-left"></i>
        <span>Go Back to Main Menu</span>
      </button>
    </div>

    <!-- Columns Selection Page -->
    <div id="columnPage" style="display: none">
      <h2>Select Columns</h2>
      <ul id="columnList">
        <!-- Columns will be dynamically added here -->
      </ul>
      <button id="confirmColumns" class="main-button">
        <i class="fas fa-check"></i>
        <span>Confirm</span>
      </button>
      <button class="backToMain main-button">
        <i class="fas fa-arrow-left"></i>
        <span>Go Back to Main Menu</span>
      </button>
    </div>

    <!-- Data Preview Container -->
    <div id="dataPreviewContainer" style="display: none">
      <h3>Data Preview:</h3>
      <button class="backToMain main-button">
        <i class="fas fa-arrow-left"></i>
        <span>Go Back to Main Menu</span>
      </button>
      <div class="data-table-container">
        <table id="dataPreviewTable"></table>
      </div>
    </div>

    <!-- Queued Operations Display -->
    <div id="queueContainer">
      <h3>Queued Operations:</h3>
      <ul id="operationQueue">
        <!-- Queued operations will be displayed here -->
      </ul>
    </div>

    <!-- JavaScript Code -->
    <script>
      const vscode = acquireVsCodeApi();

      // Variables to store user selections
      let selectedCategory = null;
      let selectedOperation = null;
      let selectedColumns = [];
      let selectedOperationRequiresInput = false;

      // Array to store queued operations
      let operationQueue = [];

      // Get references to user input elements
      const userInputContainer = document.getElementById("userInputContainer");
      const userInputLabel = document.getElementById("userInputLabel");
      const userInputField = document.getElementById("userInputField");

      // Navigation functions
      function navigateToPage(pageId) {
        // Hide all pages
        document.getElementById("mainMenu").style.display = "none";
        document.getElementById("categoryPage").style.display = "none";
        document.getElementById("operationPage").style.display = "none";
        document.getElementById("columnPage").style.display = "none";
        document.getElementById("dataPreviewContainer").style.display = "none";
        // Show the selected page
        document.getElementById(pageId).style.display = "block";
      }

      // Reset selections function
      function resetSelections() {
        // Reset selection variables
        selectedCategory = null;
        selectedOperation = null;
        selectedColumns = [];
        selectedOperationRequiresInput = false;
        userInputField.value = "";

        // Reset UI selections
        // Deselect category
        const categoryList = document.getElementById("categoryList");
        if (categoryList) {
          Array.from(categoryList.children).forEach((el) =>
            el.classList.remove("selected")
          );
        }

        // Clear operations list
        const operationList = document.getElementById("operationList");
        if (operationList) {
          operationList.innerHTML = "";
        }

        // Deselect columns
        const columnList = document.getElementById("columnList");
        if (columnList) {
          Array.from(columnList.children).forEach((el) =>
            el.classList.remove("selected")
          );
        }

        // Hide user input container
        userInputContainer.style.display = "none";
      }

      // Event listeners for main menu buttons
      document
        .getElementById("categoryButton")
        .addEventListener("click", () => {
          navigateToPage("categoryPage");
          // Request categories from the extension
          vscode.postMessage({ command: "requestCategories" });
        });

      document
        .getElementById("operationButton")
        .addEventListener("click", () => {
          if (!selectedCategory) {
            alert("Please select a category first.");
            return;
          }
          navigateToPage("operationPage");
          // Request operations for the selected category
          vscode.postMessage({
            command: "categorySelected",
            category: selectedCategory,
          });
        });

      document.getElementById("columnButton").addEventListener("click", () => {
        navigateToPage("columnPage");
        // Columns should have been received on startup
      });

      document
        .getElementById("changeFileButton")
        .addEventListener("click", () => {
          vscode.postMessage({ command: "changeFile" });
        });

      document.getElementById("previewButton").addEventListener("click", () => {
        vscode.postMessage({ command: "previewData" });
      });

      // Event listener for "Queue Operation" button
      document
        .getElementById("queueOperation")
        .addEventListener("click", queueOperation);

      // Event listener for "Perform Operation(s)" button
      document
        .getElementById("performOperations")
        .addEventListener("click", () => {
          if (operationQueue.length === 0) {
            alert("No operations queued.");
            return;
          }

          vscode.postMessage({
            command: "performOperations",
            operations: operationQueue,
          });

          // Clear the operation queue after performing
          operationQueue = [];
          updateOperationQueueDisplay();
        });

      // Function to queue an operation
      function queueOperation() {
        if (
          !selectedCategory ||
          !selectedOperation ||
          selectedColumns.length === 0
        ) {
          alert(
            "Please ensure you have selected a category, operation, and at least one column."
          );
          return;
        }

        const userInput = selectedOperationRequiresInput
          ? userInputField.value
          : null;

        // Add the operation to the queue
        operationQueue.push({
          category: selectedCategory,
          operationName: selectedOperation,
          columns: selectedColumns.slice(), // Copy the array
          userInput: userInput,
        });

        // Update the operation queue display
        updateOperationQueueDisplay();

        // Reset selections for the next operation
        resetSelections();
        navigateToPage("mainMenu");
      }

      // Function to update the displayed operation queue
      function updateOperationQueueDisplay() {
        const operationQueueList = document.getElementById("operationQueue");
        operationQueueList.innerHTML = ""; // Clear the list

        operationQueue.forEach((op, index) => {
          const listItem = document.createElement("li");
          listItem.textContent = `${index + 1}. ${
            op.operationName
          } on [${op.columns.join(", ")}]`;
          if (op.userInput) {
            listItem.textContent += ` with input "${op.userInput}"`;
          }
          operationQueueList.appendChild(listItem);
        });
      }

      // Event listeners for "Go Back to Main Menu" buttons
      document.querySelectorAll(".backToMain").forEach((button) => {
        button.addEventListener("click", () => {
          navigateToPage("mainMenu");
        });
      });

      // Category selection handling
      function setCategoryOptions(categories) {
        const categoryList = document.getElementById("categoryList");
        categoryList.innerHTML = ""; // Clear previous categories
        categories.forEach((category) => {
          const option = document.createElement("li");
          option.textContent = category;
          option.addEventListener("click", () => {
            Array.from(categoryList.children).forEach((el) =>
              el.classList.remove("selected")
            );
            option.classList.add("selected");
            selectedCategory = category;
          });
          categoryList.appendChild(option);
        });
      }

      document
        .getElementById("confirmCategory")
        .addEventListener("click", () => {
          if (!selectedCategory) {
            alert("Please select a category.");
            return;
          }
          navigateToPage("mainMenu");
        });

      // Operation selection handling
      function setOperationOptions(operations) {
        const operationList = document.getElementById("operationList");
        operationList.innerHTML = ""; // Clear previous operations
        operations.forEach((operation) => {
          const option = document.createElement("li");
          option.textContent = operation.name;
          option.addEventListener("click", () => {
            Array.from(operationList.children).forEach((el) =>
              el.classList.remove("selected")
            );
            option.classList.add("selected");
            selectedOperation = operation.name;
            selectedOperationRequiresInput = operation.needsUserInput || false;

            if (selectedOperationRequiresInput) {
              userInputContainer.style.display = "block";
              userInputLabel.textContent = operation.userInputPlaceholder || "";
              userInputField.value = ""; // Clear previous input
            } else {
              userInputContainer.style.display = "none";
            }
          });
          operationList.appendChild(option);
        });
      }

      document
        .getElementById("confirmOperation")
        .addEventListener("click", () => {
          if (!selectedOperation) {
            alert("Please select an operation.");
            return;
          }
          navigateToPage("mainMenu");
        });

      // Columns selection handling
      function setColumnOptions(columns) {
        const columnList = document.getElementById("columnList");
        columnList.innerHTML = ""; // Clear previous columns
        columns.forEach((column) => {
          const option = document.createElement("li");
          option.textContent = column;
          option.addEventListener("click", () => {
            if (option.classList.contains("selected")) {
              option.classList.remove("selected");
              selectedColumns = selectedColumns.filter((col) => col !== column);
            } else {
              option.classList.add("selected");
              selectedColumns.push(column);
            }
          });
          columnList.appendChild(option);
        });
      }

      document
        .getElementById("confirmColumns")
        .addEventListener("click", () => {
          if (selectedColumns.length === 0) {
            alert("Please select at least one column.");
            return;
          }
          navigateToPage("mainMenu");
        });

      // Display data preview
      function displayDataPreview(data) {
        const dataPreviewTable = document.getElementById("dataPreviewTable");
        dataPreviewTable.innerHTML = ""; // Clear previous preview data
        data.forEach((row, index) => {
          const rowElement = document.createElement("tr");
          row.forEach((cell) => {
            const cellElement = document.createElement(
              index === 0 ? "th" : "td"
            );
            cellElement.textContent = cell;
            rowElement.appendChild(cellElement);
          });
          dataPreviewTable.appendChild(rowElement);
        });
        navigateToPage("dataPreviewContainer"); // Show the preview page
      }

      // Message handling from the extension
      window.addEventListener("message", (event) => {
        const message = event.data;
        switch (message.command) {
          case "setColumns":
            setColumnOptions(message.columns);
            break;
          case "setCategories":
            setCategoryOptions(message.categories);
            break;
          case "setOperations":
            setOperationOptions(message.operations);
            break;
          case "showDataPreview":
            displayDataPreview(message.data);
            break;
        }
      });

      // Notify the extension that the webview is ready
      vscode.postMessage({ command: "ready" });
    </script>
  </body>
</html>
