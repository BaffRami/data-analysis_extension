<!DOCTYPE html>
<html lang="en">
  <head>
    <!-- Meta tags and title -->
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Data Analysis Extension</title>

    <!-- Link to the stylesheet -->
    <link href="style.css" rel="stylesheet" />

    <!-- Include local Font Awesome CSS -->
    <link rel="stylesheet" href="css/all.min.css" />
  </head>
  <body>
    <!-- Main Menu -->
    <div id="mainMenu">
      <!-- Main Buttons with Icons -->
      <button id="startAnalysisButton" class="main-button">
        <i class="fas fa-play-circle"></i>
        <span>Start Analysis</span>
      </button>

      <!-- Create Custom Operation Button -->
      <button id="createCustomOperationButton" class="main-button">
        <i class="fas fa-plus-circle"></i>
        <span>Create Custom Operation</span>
      </button>

      <!-- New Button for Managing Custom Operations -->
      <button id="manageCustomOperationsButton" class="main-button">
        <i class="fas fa-edit"></i>
        <span>Manage Custom Operations</span>
      </button>

      <!-- New Button for Managing Categories -->
      <button id="manageCategoriesButton" class="main-button">
        <i class="fas fa-folder-minus"></i>
        <span>Manage Categories</span>
      </button>

      <!-- Secondary Buttons Container -->
      <div class="secondary-buttons-container">
        <!-- Secondary Buttons -->
        <button
          id="changeFileButton"
          class="secondary-button"
          title="Change File"
        >
          <i class="fas fa-folder-open"></i>
        </button>
        <button
          id="previewButton"
          class="secondary-button"
          title="Preview Data"
        >
          <i class="fas fa-eye"></i>
        </button>
        <button
          id="queueOperation"
          class="secondary-button"
          title="Queue Operation"
        >
          <i class="fas fa-plus"></i>
        </button>
        <button
          id="performOperations"
          class="secondary-button"
          title="Perform Operations"
        >
          <i class="fas fa-play"></i>
        </button>
      </div>
    </div>

    <!-- Secondary Pages -->
    <!-- Category Selection Page -->
    <div id="categoryPage" style="display: none">
      <h2>Select Category</h2>
      <ul id="categoryList">
        <!-- Categories will be dynamically added here -->
      </ul>
      <button id="nextFromCategory" class="main-button">
        <i class="fas fa-arrow-right"></i>
        <span>Next</span>
      </button>
      <button class="backButton main-button">
        <i class="fas fa-arrow-left"></i>
        <span>Back</span>
      </button>
    </div>

    <!-- Operation Selection Page -->
    <div id="operationPage" style="display: none">
      <h2>Select Operation</h2>
      <ul id="operationList">
        <!-- Operations will be dynamically added here -->
      </ul>
      <!-- User Input Field -->
      <div id="userInputContainer" style="display: none">
        <h3>User Inputs:</h3>
        <div id="userInputFieldsContainer">
          <!-- User input fields will be added here dynamically -->
        </div>
      </div>
      <button id="nextFromOperation" class="main-button">
        <i class="fas fa-arrow-right"></i>
        <span>Next</span>
      </button>
      <button id="finishOperation" class="main-button" style="display: none">
        <i class="fas fa-check"></i>
        <span>Finish</span>
      </button>
      <button class="backButton main-button">
        <i class="fas fa-arrow-left"></i>
        <span>Back</span>
      </button>
      <button class="mainMenuButton main-button">
        <i class="fas fa-home"></i>
        <span>Main Menu</span>
      </button>
    </div>

    <!-- Columns Selection Page -->
    <div id="columnPage" style="display: none">
      <h2>Select Columns</h2>
      <ul id="columnList">
        <!-- Columns will be dynamically added here -->
      </ul>
      <button id="finishColumns" class="main-button">
        <i class="fas fa-check"></i>
        <span>Finish</span>
      </button>
      <button class="backButton main-button">
        <i class="fas fa-arrow-left"></i>
        <span>Back</span>
      </button>
      <button class="mainMenuButton main-button">
        <i class="fas fa-home"></i>
        <span>Main Menu</span>
      </button>
    </div>

    <!-- Data Preview Container -->
    <div id="dataPreviewContainer" style="display: none">
      <h3>Data Preview:</h3>
      <button class="backButton main-button">
        <i class="fas fa-arrow-left"></i>
        <span>Back</span>
      </button>
      <div class="data-table-container">
        <table id="dataPreviewTable"></table>
      </div>
    </div>

    <!-- Create Custom Operation Page -->
    <div id="createCustomOperationPage" style="display: none">
      <h2>Create Custom Operation</h2>
      <form id="customOperationForm">
        <label for="operationName">Operation Name:</label>
        <input type="text" id="operationName" required />

        <label for="operationCategory">Operation Category:</label>
        <input type="text" id="operationCategory" required autocomplete="off" />
        <!-- Container for category suggestions -->
        <div id="categorySuggestions" class="suggestions-list"></div>

        <label>
          <input type="checkbox" id="needsUserInput" />
          Requires User Input
        </label>

        <!-- User Inputs Container -->
        <div id="userInputsContainer" style="display: none">
          <button
            type="button"
            id="addUserInputButton"
            class="secondary-button"
          >
            <i class="fas fa-plus"></i>
            <span>Add User Input Placeholder</span>
          </button>
          <button
            type="button"
            id="removeUserInputButton"
            class="secondary-button"
          >
            <i class="fas fa-minus"></i>
            <span>Remove Last User Input</span>
          </button>
          <div id="userInputsList"></div>
        </div>

        <label for="operationCode">Operation Code:</label>
        <textarea id="operationCode" rows="8" required></textarea>

        <label>
          <input type="checkbox" id="requiresColumns" checked />
          Requires Column Selection
        </label>

        <!-- Column Placeholder Note -->
        <div id="columnPlaceholderNote" style="display: none">
          <p>
            Note: You cannot use column placeholders (&c0, &c1, etc.) when
            "Requires Column Selection" is unchecked.
          </p>
        </div>

        <button
          type="submit"
          id="submitCustomOperationButton"
          class="main-button"
        >
          <i class="fas fa-save"></i>
          <span>Save Custom Operation</span>
        </button>
        <button
          type="button"
          id="resetCustomOperationFormButton"
          class="main-button"
        >
          <i class="fas fa-undo-alt"></i>
          <span>Reset All Fields</span>
        </button>
        <button class="backButton main-button" type="button">
          <i class="fas fa-arrow-left"></i>
          <span>Back</span>
        </button>
      </form>
    </div>

    <!-- Manage Custom Operations Page -->
    <div id="manageCustomOperationsPage" style="display: none">
      <h2>Manage Custom Operations</h2>
      <ul id="customOperationsList">
        <!-- Custom operations will be dynamically added here -->
      </ul>
      <button class="backButton main-button">
        <i class="fas fa-arrow-left"></i>
        <span>Back</span>
      </button>
    </div>

    <!-- Manage Categories Page -->
    <div id="manageCategoriesPage" style="display: none">
      <h2>Manage Categories</h2>
      <ul id="categoriesList">
        <!-- Categories will be dynamically added here -->
      </ul>
      <button class="backButton main-button">
        <i class="fas fa-arrow-left"></i>
        <span>Back</span>
      </button>
    </div>

    <!-- Queued Operations Display -->
    <div id="queueContainer">
      <h3>Queued Operations:</h3>
      <ul id="operationQueue">
        <!-- Queued operations will be displayed here -->
      </ul>
    </div>

    <!-- JavaScript Code -->
    <script>
      const vscode = acquireVsCodeApi();

      // Variables to store user selections
      let selectedCategory = null;
      let selectedOperation = null;
      let selectedColumns = [];
      let selectedOperationRequiresInput = false;
      let selectedOperationPlaceholders = [];
      let selectedOperationRequiresColumns = false;
      let existingCategories = []; // Store existing categories

      // References to elements
      const operationCategoryInput =
        document.getElementById("operationCategory");
      const categorySuggestionsContainer = document.getElementById(
        "categorySuggestions"
      );

      // Array to store queued operations
      let operationQueue = [];

      // Navigation history for back button functionality
      let navigationHistory = [];

      // Get references to user input elements
      const userInputContainer = document.getElementById("userInputContainer");
      const userInputFieldsContainer = document.getElementById(
        "userInputFieldsContainer"
      );

      // Navigation functions
      function navigateToPage(pageId) {
        // Hide all pages
        const pages = [
          "mainMenu",
          "categoryPage",
          "operationPage",
          "columnPage",
          "dataPreviewContainer",
          "createCustomOperationPage",
          "manageCustomOperationsPage",
          "manageCategoriesPage",
        ];
        pages.forEach((id) => {
          document.getElementById(id).style.display = "none";
        });
        // Show the selected page
        document.getElementById(pageId).style.display = "block";

        // Update navigation history
        if (navigationHistory[navigationHistory.length - 1] !== pageId) {
          navigationHistory.push(pageId);
        }
      }

      // Reset selections function
      function resetSelections() {
        // Reset selection variables
        selectedCategory = null;
        selectedOperation = null;
        selectedColumns = [];
        selectedOperationRequiresInput = false;
        selectedOperationPlaceholders = [];
        selectedOperationRequiresColumns = false;

        // Reset UI selections
        // Deselect category
        const categoryList = document.getElementById("categoryList");
        if (categoryList) {
          Array.from(categoryList.children).forEach((el) =>
            el.classList.remove("selected")
          );
        }

        // Clear operations list
        const operationList = document.getElementById("operationList");
        if (operationList) {
          operationList.innerHTML = "";
        }

        // Deselect columns
        const columnList = document.getElementById("columnList");
        if (columnList) {
          Array.from(columnList.children).forEach((el) =>
            el.classList.remove("selected")
          );
        }

        // Hide user input container
        userInputContainer.style.display = "none";
        userInputFieldsContainer.innerHTML = "";
      }

      // Event listener for "Start Analysis" button
      document
        .getElementById("startAnalysisButton")
        .addEventListener("click", () => {
          resetSelections(); // Reset previous selections
          navigateToPage("categoryPage");
          // Request categories from the extension
          vscode.postMessage({ command: "requestCategories" });
        });

      // Event listener for "Manage Categories" button
      document
        .getElementById("manageCategoriesButton")
        .addEventListener("click", () => {
          navigateToPage("manageCategoriesPage");
          // Request categories from the extension
          vscode.postMessage({ command: "requestCategoriesForManagement" });
        });

      // Event listener for "Change File" button
      document
        .getElementById("changeFileButton")
        .addEventListener("click", () => {
          vscode.postMessage({ command: "changeFile" });
        });

      // Event listener for "Preview Data" button
      document.getElementById("previewButton").addEventListener("click", () => {
        vscode.postMessage({ command: "previewData" });
      });

      // Event listener for "Queue Operation" button
      document
        .getElementById("queueOperation")
        .addEventListener("click", queueOperation);

      // Event listener for "Perform Operation(s)" button
      document
        .getElementById("performOperations")
        .addEventListener("click", () => {
          if (operationQueue.length === 0) {
            alert("No operations queued.");
            return;
          }

          vscode.postMessage({
            command: "performOperations",
            operations: operationQueue,
          });

          // Clear the operation queue after performing
          operationQueue = [];
          updateOperationQueueDisplay();
        });

      // Function to queue an operation
      function queueOperation() {
        if (!selectedCategory || !selectedOperation) {
          alert("Please ensure you have completed the operation selection.");
          return;
        }
        if (selectedOperationRequiresColumns && selectedColumns.length === 0) {
          alert("Please select at least one column for this operation.");
          return;
        }

        let userInputs = [];
        if (selectedOperationRequiresInput) {
          const userInputFields = document.querySelectorAll(".userInputField");
          userInputFields.forEach((input) => {
            userInputs.push(input.value.trim());
          });
        }

        // Add the operation to the queue
        operationQueue.push({
          category: selectedCategory,
          operationName: selectedOperation,
          columns: selectedColumns.slice(),
          userInputs: userInputs,
        });

        // Update the operation queue display
        updateOperationQueueDisplay();

        // Reset selections for the next operation
        resetSelections();
        navigateToPage("mainMenu");
      }

      // Function to update the displayed operation queue
      function updateOperationQueueDisplay() {
        const operationQueueList = document.getElementById("operationQueue");
        operationQueueList.innerHTML = ""; // Clear the list

        operationQueue.forEach((op, index) => {
          let listItem = document.createElement("li");
          listItem.textContent = `${index + 1}. ${
            op.operationName
          } on [${op.columns.join(", ")}]`;
          if (op.userInputs && op.userInputs.length > 0) {
            listItem.textContent += ` with inputs: "${op.userInputs.join(
              '", "'
            )}"`;
          }
          operationQueueList.appendChild(listItem);
        });
      }

      // Event listeners for "Back" buttons
      document.querySelectorAll(".backButton").forEach((button) => {
        button.addEventListener("click", () => {
          navigationHistory.pop(); // Remove current page
          const previousPage = navigationHistory.pop(); // Get the previous page
          if (previousPage) {
            navigateToPage(previousPage);
          } else {
            navigateToPage("mainMenu");
          }
        });
      });

      // Event listeners for "Main Menu" buttons
      document.querySelectorAll(".mainMenuButton").forEach((button) => {
        button.addEventListener("click", () => {
          navigationHistory = [];
          resetSelections();
          navigateToPage("mainMenu");
        });
      });

      // Category selection handling
      function setCategoryOptions(categories) {
        existingCategories = categories; // Store for later use
        const categoryList = document.getElementById("categoryList");
        categoryList.innerHTML = ""; // Clear previous categories
        categories.forEach((category) => {
          const option = document.createElement("li");
          option.textContent = category;
          option.addEventListener("click", () => {
            Array.from(categoryList.children).forEach((el) =>
              el.classList.remove("selected")
            );
            option.classList.add("selected");
            selectedCategory = category;
          });
          categoryList.appendChild(option);
        });
      }

      // Operation selection handling
      function setOperationOptions(operations) {
        const operationList = document.getElementById("operationList");
        operationList.innerHTML = ""; // Clear previous operations
        operations.forEach((operation) => {
          const option = document.createElement("li");
          option.textContent = operation.name;
          option.addEventListener("click", () => {
            Array.from(operationList.children).forEach((el) =>
              el.classList.remove("selected")
            );
            option.classList.add("selected");
            selectedOperation = operation.name;
            selectedOperationRequiresInput = operation.needsUserInput || false;
            selectedOperationPlaceholders =
              operation.userInputPlaceholders || [];
            selectedOperationRequiresColumns =
              operation.requiresColumns || false;

            // Show or hide the appropriate buttons
            if (selectedOperationRequiresColumns) {
              document.getElementById("nextFromOperation").style.display =
                "inline-flex";
              document.getElementById("finishOperation").style.display = "none";
            } else {
              document.getElementById("nextFromOperation").style.display =
                "none";
              document.getElementById("finishOperation").style.display =
                "inline-flex";
            }

            if (selectedOperationRequiresInput) {
              userInputContainer.style.display = "block";
              userInputFieldsContainer.innerHTML = ""; // Clear previous inputs

              selectedOperationPlaceholders.forEach((placeholder, index) => {
                const inputDiv = document.createElement("div");
                inputDiv.className = "user-input-item";

                const label = document.createElement("label");
                label.textContent = placeholder;

                const inputField = document.createElement("input");
                inputField.type = "text";
                inputField.className = "userInputField";
                inputField.dataset.index = index;
                inputField.required = true;

                inputDiv.appendChild(label);
                inputDiv.appendChild(inputField);
                userInputFieldsContainer.appendChild(inputDiv);
              });
            } else {
              userInputContainer.style.display = "none";
            }
          });
          operationList.appendChild(option);
        });
      }

      // Columns selection handling
      function setColumnOptions(columns) {
        const columnList = document.getElementById("columnList");
        columnList.innerHTML = ""; // Clear previous columns
        columns.forEach((column) => {
          const option = document.createElement("li");
          option.textContent = column;
          option.addEventListener("click", () => {
            if (option.classList.contains("selected")) {
              option.classList.remove("selected");
              selectedColumns = selectedColumns.filter((col) => col !== column);
            } else {
              option.classList.add("selected");
              selectedColumns.push(column);
            }
          });
          columnList.appendChild(option);
        });
      }

      // Next button from Category Page
      document
        .getElementById("nextFromCategory")
        .addEventListener("click", () => {
          if (!selectedCategory) {
            alert("Please select a category.");
            return;
          }
          // Request operations for the selected category
          vscode.postMessage({
            command: "categorySelected",
            category: selectedCategory,
          });
          navigateToPage("operationPage");
        });

      // Next button from Operation Page
      document
        .getElementById("nextFromOperation")
        .addEventListener("click", () => {
          if (!selectedOperation) {
            alert("Please select an operation.");
            return;
          }
          navigateToPage("columnPage");
        });

      // Finish button on Operation Page (for operations that don't require columns)
      document
        .getElementById("finishOperation")
        .addEventListener("click", () => {
          if (!selectedOperation) {
            alert("Please select an operation.");
            return;
          }
          navigateToPage("mainMenu");
        });

      // Finish button on Columns Page
      document.getElementById("finishColumns").addEventListener("click", () => {
        if (selectedOperationRequiresColumns && selectedColumns.length === 0) {
          alert("Please select at least one column.");
          return;
        }
        navigateToPage("mainMenu");
      });

      // Display data preview
      function displayDataPreview(data) {
        const dataPreviewTable = document.getElementById("dataPreviewTable");
        dataPreviewTable.innerHTML = ""; // Clear previous preview data
        data.forEach((row, index) => {
          const rowElement = document.createElement("tr");
          row.forEach((cell) => {
            const cellElement = document.createElement(
              index === 0 ? "th" : "td"
            );
            cellElement.textContent = cell;
            rowElement.appendChild(cellElement);
          });
          dataPreviewTable.appendChild(rowElement);
        });
        navigateToPage("dataPreviewContainer"); // Show the preview page
      }

      // Event listener for "Create Custom Operation" button
      document
        .getElementById("createCustomOperationButton")
        .addEventListener("click", () => {
          navigateToPage("createCustomOperationPage");
        });

      // Event listener for "Manage Custom Operations" button
      document
        .getElementById("manageCustomOperationsButton")
        .addEventListener("click", () => {
          navigateToPage("manageCustomOperationsPage");
          // Request custom operations from the extension
          vscode.postMessage({ command: "requestCustomOperations" });
        });

      // Function to display custom operations
      function displayCustomOperations(customOperations) {
        const customOperationsList = document.getElementById(
          "customOperationsList"
        );
        customOperationsList.innerHTML = ""; // Clear previous entries

        customOperations.forEach((operation) => {
          const listItem = document.createElement("li");
          listItem.className = "custom-operation-item";
          listItem.innerHTML = `
          <span><strong>${operation.name}</strong> (${operation.category})</span>
          <button class="delete-operation-button" data-filename="${operation.fileName}">
            <i class="fas fa-trash-alt"></i> Delete
          </button>
        `;

          customOperationsList.appendChild(listItem);
        });

        // Add event listeners for delete buttons
        const deleteButtons = customOperationsList.querySelectorAll(
          ".delete-operation-button"
        );
        deleteButtons.forEach((button) => {
          button.addEventListener("click", (event) => {
            const fileName = event.currentTarget.dataset.filename;
            // Send a message to the extension to confirm deletion
            vscode.postMessage({
              command: "confirmDeleteCustomOperation",
              fileName: fileName,
            });
          });
        });
      }

      // Function to display categories in the Manage Categories Page
      function displayCategoriesForManagement(categories) {
        const categoriesList = document.getElementById("categoriesList");
        categoriesList.innerHTML = ""; // Clear previous entries

        categories.forEach((category) => {
          const listItem = document.createElement("li");
          listItem.className = "category-item";
          listItem.innerHTML = `
          <span><strong>${category}</strong></span>
          <button class="delete-category-button" data-category="${category}">
            <i class="fas fa-trash-alt"></i> Delete
          </button>
        `;

          categoriesList.appendChild(listItem);
        });

        // Add event listeners for delete buttons
        const deleteButtons = categoriesList.querySelectorAll(
          ".delete-category-button"
        );
        deleteButtons.forEach((button) => {
          button.addEventListener("click", (event) => {
            const categoryName = event.currentTarget.dataset.category;
            // Send a message to the extension to confirm deletion
            vscode.postMessage({
              command: "confirmDeleteCategory",
              category: categoryName,
            });
          });
        });
      }

      // Show or hide the user inputs container based on the checkbox
      document
        .getElementById("needsUserInput")
        .addEventListener("change", function () {
          const userInputsContainer = document.getElementById(
            "userInputsContainer"
          );
          if (this.checked) {
            userInputsContainer.style.display = "block";
          } else {
            userInputsContainer.style.display = "none";
            // Clear the user inputs list
            document.getElementById("userInputsList").innerHTML = "";
          }
        });

      // Handle adding user input placeholders
      document
        .getElementById("addUserInputButton")
        .addEventListener("click", function () {
          const userInputsList = document.getElementById("userInputsList");
          const inputCount = userInputsList.children.length;

          const inputDiv = document.createElement("div");
          inputDiv.className = "user-input-item";

          const label = document.createElement("label");
          label.textContent = `User Input Placeholder ${inputCount + 1}:`;

          const inputField = document.createElement("input");
          inputField.type = "text";
          inputField.className = "userInputPlaceholder";
          inputField.required = true;

          inputDiv.appendChild(label);
          inputDiv.appendChild(inputField);
          userInputsList.appendChild(inputDiv);
        });

      // Event listener for "Remove Last User Input" button
      document
        .getElementById("removeUserInputButton")
        .addEventListener("click", function () {
          const userInputsList = document.getElementById("userInputsList");
          if (userInputsList.children.length > 0) {
            userInputsList.removeChild(userInputsList.lastChild);
          }
        });

      // Handle the custom operation form submission
      document
        .getElementById("customOperationForm")
        .addEventListener("submit", function (e) {
          e.preventDefault();
          const operationName = document.getElementById("operationName").value;
          let operationCategory = operationCategoryInput.value.trim();
          const needsUserInput =
            document.getElementById("needsUserInput").checked;
          const operationCode = document.getElementById("operationCode").value;
          const requiresColumns =
            document.getElementById("requiresColumns").checked;

          // Collect multiple user input placeholders
          let userInputPlaceholders = [];
          if (needsUserInput) {
            const userInputFields = document.querySelectorAll(
              ".userInputPlaceholder"
            );
            userInputFields.forEach((input) => {
              userInputPlaceholders.push(input.value.trim());
            });
          }

          // Perform case-insensitive category matching
          const matchedCategory = existingCategories.find(
            (cat) => cat.toLowerCase() === operationCategory.toLowerCase()
          );
          if (matchedCategory) {
            operationCategory = matchedCategory; // Use the existing category with original casing
          }

          // Validate operation code for column placeholders
          const columnPlaceholderRegex = /&c\d+/;
          if (!requiresColumns && columnPlaceholderRegex.test(operationCode)) {
            alert(
              "You cannot use &c0, &c1, etc., in the operation code when 'Requires Column Selection' is unchecked."
            );
            return;
          }
          if (requiresColumns && !columnPlaceholderRegex.test(operationCode)) {
            alert(
              "Operation code must contain at least one &c0, &c1, etc., when 'Requires Column Selection' is checked."
            );
            return;
          }

          // Send the data to the extension backend
          vscode.postMessage({
            command: "createCustomOperation",
            data: {
              name: operationName,
              category: operationCategory,
              needsUserInput: needsUserInput,
              userInputPlaceholders: userInputPlaceholders,
              operationCode: operationCode,
              requiresColumns: requiresColumns, // Include this field
            },
          });

          // Reset the form
          this.reset();
          document.getElementById("userInputsContainer").style.display = "none";
          document.getElementById("userInputsList").innerHTML = "";

          // Hide column placeholder note
          document.getElementById("columnPlaceholderNote").style.display =
            "none";

          // Navigate back to main menu
          navigateToPage("mainMenu");
        });

      // Event listener for "Reset All Fields" button
      document
        .getElementById("resetCustomOperationFormButton")
        .addEventListener("click", function () {
          // Reset the form
          document.getElementById("customOperationForm").reset();
          // Hide and clear the user inputs container
          document.getElementById("userInputsContainer").style.display = "none";
          document.getElementById("userInputsList").innerHTML = "";
          // Hide column placeholder note
          document.getElementById("columnPlaceholderNote").style.display =
            "none";
          // Hide category suggestions
          categorySuggestionsContainer.style.display = "none";
        });

      // Event listeners for custom autocomplete
      operationCategoryInput.addEventListener("input", onCategoryInputChange);

      operationCategoryInput.addEventListener("focus", onCategoryInputFocus);

      operationCategoryInput.addEventListener("blur", () => {
        setTimeout(() => {
          categorySuggestionsContainer.style.display = "none";
        }, 200);
      });

      function onCategoryInputChange() {
        const inputValue = operationCategoryInput.value.toLowerCase();
        categorySuggestionsContainer.innerHTML = ""; // Clear previous suggestions

        if (inputValue === "") {
          categorySuggestionsContainer.style.display = "none";
          return;
        }

        const filteredCategories = existingCategories.filter((category) =>
          category.toLowerCase().includes(inputValue)
        );

        if (filteredCategories.length === 0) {
          categorySuggestionsContainer.style.display = "none";
          return;
        }

        filteredCategories.forEach((category) => {
          const suggestionItem = document.createElement("div");
          suggestionItem.classList.add("suggestion-item");
          suggestionItem.textContent = category;

          suggestionItem.addEventListener("click", () => {
            operationCategoryInput.value = category;
            categorySuggestionsContainer.innerHTML = "";
            categorySuggestionsContainer.style.display = "none";
          });

          categorySuggestionsContainer.appendChild(suggestionItem);
        });

        categorySuggestionsContainer.style.display = "block";
      }

      function onCategoryInputFocus() {
        if (operationCategoryInput.value !== "") {
          onCategoryInputChange();
        }
      }

      // Message handling from the extension
      window.addEventListener("message", (event) => {
        const message = event.data;
        switch (message.command) {
          case "setColumns":
            setColumnOptions(message.columns);
            break;
          case "setCategories":
            setCategoryOptions(message.categories);
            break;
          case "setCategoriesForManagement":
            displayCategoriesForManagement(message.categories);
            break;
          case "setOperations":
            setOperationOptions(message.operations);
            break;
          case "showDataPreview":
            displayDataPreview(message.data);
            break;
          case "setCustomOperations":
            displayCustomOperations(message.customOperations);
            break;
          case "categoryDeleted":
            // If the current page is managing categories, refresh the list
            if (
              navigationHistory[navigationHistory.length - 1] ===
              "manageCategoriesPage"
            ) {
              vscode.postMessage({ command: "requestCategoriesForManagement" });
            }
            break;
          case "deleteCategorySuccess":
            vscode.window.showInformationMessage(message.message);
            break;
          case "deleteCategoryFailure":
            vscode.window.showErrorMessage(message.message);
            break;
          case "deleteOperationSuccess":
            vscode.window.showInformationMessage(message.message);
            // Refresh the custom operations list
            vscode.postMessage({ command: "requestCustomOperations" });
            break;
          case "deleteOperationFailure":
            vscode.window.showErrorMessage(message.message);
            break;
          default:
            console.error(`Unknown command received: ${message.command}`);
            break;
        }
      });

      // Show or hide the column placeholder note based on the checkbox
      document
        .getElementById("requiresColumns")
        .addEventListener("change", function () {
          const columnPlaceholderNote = document.getElementById(
            "columnPlaceholderNote"
          );
          if (this.checked) {
            columnPlaceholderNote.style.display = "none";
          } else {
            columnPlaceholderNote.style.display = "block";
          }
        });

      // Notify the extension that the webview is ready
      vscode.postMessage({ command: "ready" });
    </script>
  </body>
</html>
